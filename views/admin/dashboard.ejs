<%- include('partials/header', { title: 'Admin Dashboard' }) %>

<%
// Default stats if not provided
const defaultStats = {
    totalUsers: 1247,
    activeUsers: 1156,
    totalInstructors: 89,
    pendingUsers: 12,
    pendingInstructors: 5,
    notifications: 3
};

const displayStats = (typeof stats !== 'undefined' && stats) ? stats : defaultStats;

// Sample data if recentUsers is not provided
const sampleUsers = [
    {
        _id: '1',
        name: 'John Doe',
        email: 'john.doe@example.com',
        role: 'student',
        status: 'active',
        createdAt: new Date()
    },
    {
        _id: '2',
        name: 'Sarah Wilson',
        email: 'sarah.wilson@example.com',
        role: 'instructor',
        status: 'active',
        createdAt: new Date(Date.now() - 86400000)
    },
    {
        _id: '3',
        name: 'Mike Chen',
        email: 'mike.chen@example.com',
        role: 'student',
        status: 'inactive',
        createdAt: new Date(Date.now() - 172800000)
    }
];

const displayUsers = (typeof recentUsers !== 'undefined' && recentUsers) ? recentUsers : sampleUsers;
%>

<!-- Main Layout -->
<div class="flex h-screen bg-gray-50">
    <!-- Sidebar -->
    <%- include('partials/sidebar', { currentPage: 'dashboard', user: user, stats: displayStats }) %>
    
    <!-- Main Content -->
    <div class="flex-1 lg:ml-64 flex flex-col overflow-hidden">
        <!-- Top Navigation -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="flex items-center justify-between px-6 py-4">
                <div class="flex items-center space-x-4">
                    <!-- Mobile Menu Button -->
                    <button id="mobileMenuBtn" class="lg:hidden p-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-bars text-gray-600"></i>
                    </button>
                    
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
                        <p class="text-sm text-gray-500">Welcome back, <%= user ? user.name : 'Admin' %>!</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Notifications -->
                    <div class="relative">
                        <button class="p-2 rounded-lg hover:bg-gray-100 relative">
                            <i class="fas fa-bell text-gray-600"></i>
                            <% if (displayStats && displayStats.notifications > 0) { %>
                                <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"><%= displayStats.notifications %></span>
                            <% } %>
                        </button>
                    </div>
                    
                    <!-- Profile Dropdown -->
                    <div class="relative">
                        <button class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <% if (user && user.avatar) { %>
                                    <img src="<%= user.avatar %>" alt="Admin" class="w-8 h-8 rounded-full object-cover">
                                <% } else { %>
                                    <i class="fas fa-user text-white text-sm"></i>
                                <% } %>
                            </div>
                            <span class="hidden md:block text-sm font-medium text-gray-700"><%= user ? user.name : 'Admin' %></span>
                            <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Dashboard Content -->
        <main class="flex-1 overflow-y-auto p-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

                <!-- Total Users -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">Total Users</p>
                            <p class="text-3xl font-bold text-gray-800"><%= displayStats.totalUsers.toLocaleString() %></p>
                            <div class="flex items-center mt-2">
                                <i class="fas fa-arrow-up text-green-500 text-sm mr-1"></i>
                                <span class="text-sm text-green-600">+12% from last month</span>
                            </div>
                        </div>
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users text-white text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Active Users -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">Active Users</p>
                            <p class="text-3xl font-bold text-gray-800"><%= displayStats.activeUsers.toLocaleString() %></p>
                            <div class="flex items-center mt-2">
                                <i class="fas fa-arrow-up text-green-500 text-sm mr-1"></i>
                                <span class="text-sm text-green-600">+8% from last month</span>
                            </div>
                        </div>
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-user-check text-white text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Total Instructors -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">Total Instructors</p>
                            <p class="text-3xl font-bold text-gray-800"><%= displayStats.totalInstructors %></p>
                            <div class="flex items-center mt-2">
                                <i class="fas fa-arrow-up text-green-500 text-sm mr-1"></i>
                                <span class="text-sm text-green-600">+5% from last month</span>
                            </div>
                        </div>
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chalkboard-teacher text-white text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Pending Approvals -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 mb-1">Pending Approvals</p>
                            <p class="text-3xl font-bold text-gray-800"><%= (displayStats.pendingUsers + displayStats.pendingInstructors) %></p>
                            <div class="flex items-center mt-2">
                                <i class="fas fa-clock text-orange-500 text-sm mr-1"></i>
                                <span class="text-sm text-orange-600">Requires attention</span>
                            </div>
                        </div>
                        <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-hourglass-half text-white text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Quick Actions Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <button onclick="openModal('createUserModal')" class="w-full flex items-center justify-between p-3 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-user-plus text-blue-600"></i>
                                <span class="font-medium text-blue-800">Create New User</span>
                            </div>
                            <i class="fas fa-chevron-right text-blue-400"></i>
                        </button>
                        
                        <button onclick="openModal('createInstructorModal')" class="w-full flex items-center justify-between p-3 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-chalkboard-teacher text-purple-600"></i>
                                <span class="font-medium text-purple-800">Add Instructor</span>
                            </div>
                            <i class="fas fa-chevron-right text-purple-400"></i>
                        </button>
                        
                        <a href="/admin/users" class="w-full flex items-center justify-between p-3 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-users text-green-600"></i>
                                <span class="font-medium text-green-800">Manage Users</span>
                            </div>
                            <i class="fas fa-chevron-right text-green-400"></i>
                        </a>
                        
                        <a href="/admin/settings" class="w-full flex items-center justify-between p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-cog text-gray-600"></i>
                                <span class="font-medium text-gray-800">System Settings</span>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </a>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Activity</h3>
                    <div class="space-y-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-user-plus text-blue-600 text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-800">New user registered</p>
                                <p class="text-xs text-gray-500">John Doe joined the platform</p>
                                <p class="text-xs text-gray-400">2 minutes ago</p>
                            </div>
                        </div>

                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-check text-green-600 text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-800">Instructor approved</p>
                                <p class="text-xs text-gray-500">Sarah Wilson's application approved</p>
                                <p class="text-xs text-gray-400">15 minutes ago</p>
                            </div>
                        </div>

                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-book text-purple-600 text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-800">New course published</p>
                                <p class="text-xs text-gray-500">"Advanced JavaScript" by Mike Chen</p>
                                <p class="text-xs text-gray-400">1 hour ago</p>
                            </div>
                        </div>

                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-red-600 text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm text-gray-800">System alert</p>
                                <p class="text-xs text-gray-500">High server load detected</p>
                                <p class="text-xs text-gray-400">2 hours ago</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <a href="/admin/logs" class="text-sm text-blue-600 hover:text-blue-800 font-medium">View all activity →</a>
                    </div>
                </div>

                <!-- System Status -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">System Status</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span class="text-sm text-gray-700">Database</span>
                            </div>
                            <span class="text-sm text-green-600 font-medium">Operational</span>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span class="text-sm text-gray-700">API Services</span>
                            </div>
                            <span class="text-sm text-green-600 font-medium">Operational</span>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                <span class="text-sm text-gray-700">File Storage</span>
                            </div>
                            <span class="text-sm text-yellow-600 font-medium">Degraded</span>
                        </div>

                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span class="text-sm text-gray-700">Email Service</span>
                            </div>
                            <span class="text-sm text-green-600 font-medium">Operational</span>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <a href="/admin/system-status" class="text-sm text-blue-600 hover:text-blue-800 font-medium">View detailed status →</a>
                    </div>
                </div>
            </div>

            <!-- Charts and Analytics -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- User Growth Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">User Growth</h3>
                        <select class="text-sm border border-gray-300 rounded-lg px-3 py-1">
                            <option>Last 7 days</option>
                            <option>Last 30 days</option>
                            <option>Last 3 months</option>
                        </select>
                    </div>
                    <div class="h-64 flex items-center justify-center bg-gray-50 rounded-lg">
                        <div class="text-center">
                            <i class="fas fa-chart-line text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Chart will be rendered here</p>
                            <p class="text-sm text-gray-400">Integration with Chart.js or similar</p>
                        </div>
                    </div>
                </div>

                <!-- Revenue Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Revenue Overview</h3>
                        <select class="text-sm border border-gray-300 rounded-lg px-3 py-1">
                            <option>This month</option>
                            <option>Last month</option>
                            <option>This year</option>
                        </select>
                    </div>
                    <div class="h-64 flex items-center justify-center bg-gray-50 rounded-lg">
                        <div class="text-center">
                            <i class="fas fa-chart-bar text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Chart will be rendered here</p>
                            <p class="text-sm text-gray-400">Integration with Chart.js or similar</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Users Table -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-800">Recent Users</h3>
                    <a href="/admin/users" class="text-sm text-blue-600 hover:text-blue-800 font-medium">View all users →</a>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-medium text-gray-700">User</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Email</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Role</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Status</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Joined</th>
                            </tr>
                        </thead>
                        <tbody>

                            <% if (displayUsers && displayUsers.length > 0) { %>
                                <% displayUsers.forEach(user => { %>
                                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                                        <td class="py-3 px-4">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                                    <% if (user.avatar) { %>
                                                        <img src="<%= user.avatar %>" alt="<%= user.name %>" class="w-8 h-8 rounded-full object-cover">
                                                    <% } else { %>
                                                        <span class="text-white text-sm font-medium"><%= user.name.charAt(0).toUpperCase() %></span>
                                                    <% } %>
                                                </div>
                                                <span class="font-medium text-gray-800"><%= user.name %></span>
                                            </div>
                                        </td>
                                        <td class="py-3 px-4 text-gray-600"><%= user.email %></td>
                                        <td class="py-3 px-4">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                                <%= user.role === 'admin' ? 'bg-red-100 text-red-800' :
                                                    user.role === 'instructor' ? 'bg-purple-100 text-purple-800' :
                                                    'bg-blue-100 text-blue-800' %>">
                                                <%= user.role.charAt(0).toUpperCase() + user.role.slice(1) %>
                                            </span>
                                        </td>
                                        <td class="py-3 px-4">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-<%= user.status %>">
                                                <%= user.status.charAt(0).toUpperCase() + user.status.slice(1) %>
                                            </span>
                                        </td>
                                        <td class="py-3 px-4 text-gray-600"><%= new Date(user.createdAt).toLocaleDateString() %></td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="5" class="py-8 text-center text-gray-500">
                                        <div class="flex flex-col items-center">
                                            <i class="fas fa-users text-4xl mb-2 text-gray-300"></i>
                                            <p class="text-lg font-medium mb-1">No recent users found</p>
                                            <p class="text-sm">Users will appear here as they register</p>
                                        </div>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<%- include('partials/footer') %>
